## ORDER 이해

- `ORDER BY` 절에 명시된 컬럼에 인덱스가 있으면, MySQL은 이미 정렬된 데이터를 사용하므로 추가적인 정렬 작업이 필요 없다.

- 인덱스가 없는 경우, `filesort` 방식으로 임시 테이블을 사용해 정렬 작업을 수행한다.

- `ORDER BY` 절이 인덱스를 사용하는지, **`filesort`** 를 이용하고 있는지 여부를 확인하기 위해 **`EXPLAIN`** 명령어를 사용할 수 있다.
	- 실행 계획의 Extra 컬럼에 **`Using filesort`** 가 있다면 **`filesort`** 를 사용하고 있는 것이다.
	- 실행 계획의 key 컬럼에 인덱스가 출력되었다면 인덱스를 사용하고 있다는 뜻이다.

## 최적화 방법

기본적으로 ORDER BY 절을 사용하는 경우에 인덱스를 사용하도록 하는 것이 좋다.
- 이는 특히 `LIMIT` 절과 함께 사용될 때 유의미한데, 인덱스가 있으면 MySQL은 필요한 만큼의 데이터만 읽고나서 처리를 중단한다. 인덱스가 없으면 전체 데이터를 정렬한 후 원하는 행의 수만큼 추출한다.

### **`filesort`** 를 이용하고 있는 경우의 최적화 방법
1. **`sort_buffer_size`** 튜닝
	- **`filesort`** 는 임시 테이블에 기록하고 **`Sort Buffer`** 를 통해 정렬을 수행한다.
	- 정렬해야 하는 데이터가 많다면 디스크 수준에서 정렬을 할 것이라서 성능이 잘 나오지 않는다.
	- 그러므로 **`sort_buffer_size`** 를 **증가시켜서 디스크 정렬을 최소화 하도록** 최적화 할 수 있다.
	- `sort_merge_passes` 변수를 통해서 디스크 정렬을 수행했는지 알 수 있다.

2. Single-Pass 에서 Two-Pass로 튜닝
	- `filesort` 는 Single-Pass와 Two-Pass 방식으로 정렬을 수행할 수 있다.
	- **Single-Pass**는 **Sort Buffer에 데이터를 모두 넣어서 정렬을 수행**
	- **Two-Pass**는 **정렬하는 컬럼과 PK만 넣어서 정렬을 수행**, 이후에 나머지 데이터와 병합.
	- 일반적으로 Single-Pass가 성능이 좋으나, 데이터의 크기가 큰 경우라면 Two-Pass가 더 성능적으로 우위
	- 의도적으로 Single-Pass에서 Two-Pass로 변경하고 싶다면 max_length_for_sort_data 변수의 값을 조절해야 함. (MySQL 8.0.20 이전의 경우에만 해당, 이후부터는 옵티마이저가 처리)

3. 문자열 정렬 튜닝
	- 문자열 컬럼은 값 전체를 사용해서 정렬하지 않고, **`max_sort_length`** 값 만큼만 잘라서 정렬을 하도록 수행한다.
	- 필요하다면 문자열을 정렬하는 경우엔 **`max_sort_length`** 값을 줄인다면 정렬 결과가 빨라질 수 있다.

## ORDER BY 고려사항

ORDER BY 절을 사용했을 때 정렬되어서 나오는 결과 순서가 동일해야한다면, `ORDER BY` 절에 고유한 값을 가진 컬럼을 포함시켜야 한다.

```sql
mysql> SELECT * FROM ratings ORDER BY category;
+----+----------+--------+
|    id    |     category    |    rating     |
+----+----------+--------+
|       1  |                      1  |             4.5  |
|       5  |                      1  |             3.2  |
|       3  |                      2  |             3.7  |
|       4  |                      2  |             3.5  |
|       6  |                      2  |             3.5  |
|       2  |                      3  |             5.0  |
|       7  |                      3  |             2.7  |
+----+----------+--------+
```