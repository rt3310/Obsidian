## LIKE 문을 통한 검색 기능의 문제점

```sql
-- Index 스캔 가능
SELECT * FROM table WHERE name LIKE 'something%';

-- 풀 스캔 때려 버림
SELECT * FROM table WHERE name LIKE '%something%';
SELECT * FROM table WHERE name LIKE '%something';
```
`%something%` 연산은 DB 인덱스의 B+Tree의 장점을 활용할 수 없고 Full Scan 할 수 있는 문제가 있다.

## B+Tree 인덱스 LIKE 연산 시 Full Scan 하는 이유

![[Pasted image 20251115230437.png]]
B+Tree 특성 상 리프 노드의 데이터는 사전 순차적으로 저장된다.
그렇기 때문에 %연산이 좌측에 있을 경우 결국 처음 리프노드부터 순차적으로 찾아봐야 되기 때문에 결국 Full Scan 문제가 발생한다.

## 풀 텍스트 인덱스(Full-Text Index)

풀

## 풀 텍스트 인덱스 Parser

### Built-In Parser
- Built-In Parser는 정관사나 부정관사를 제외한 stop word(구분자)를 기준으로 키워드를 추출하는 방식으로 작동한다.
- 공백이나 문장 기호 또는 사용자가 지정한 특정 단어를 기준으로 토크나이징하게 된다.

```
정승제는 집에서 넷플릭스를 본다 -> 정승제는 / 집에서 / 넷플릭스를 / 본다
우리는 치즈케이크를 만들었다 -> 우리는 / 치즈케이크를 / 만들었다
```
- 위와 같은 방식으로 토크나이징 된다면 "승제", "케이크"와 같은 검색 키워드로는 위 문장을 검색할 수 없다.
- FullText Search는 토큰과 검색 키워드가 전부 일치하거나 전방(prefix) 일치한 경우에만 결과를 가져오기 때문이다.
### N-gram Parser
위와 같은 문제를 해결해주기 위해 N-gram Parser가 등장하는데, 해당 Parser는 N크기의 문자열 토큰사이즈를 기준으로 키워드를 추출한다.

```
N : 2인 경우
정승제는 집에서 넷플릭스를 본다 -> 정승 / 승제 / 제는 / 는집 / 집에 / 에서 / 서넷 / 넷플 / 플릭 / 릭스 / 스를 / 를본 / 본다
우리는 치즈케이크를 만들었다 -> 우리 / 리는 / 는치 / 치즈 / 즈케 / 케이 / 이크 / 크를 / 를만 / 만들 / 들었 / 었다
```
위와 같은 방식으로 토크나이징 된다면 stop word 방식의 문제를 해결할 수 있다.
하지만 stop word에 비해 인덱스의 크기가 매우 커지는 문제가 있다.

## binary collation

자연어 검색은 기본적으로 대소문자를 구분하지 않는데, 이를 구분하기 위해 binary collation을 사용할 수 있다.

https://hoing.io/archives/8110

## 무시되는 검색어

길이가 기준보다 짧거나, 구분자(Stopword)는 풀 텍스트 검색에서 무시된다.

### 짧은 단어의 경우
```sql
mysql> show variables like '%ft_min%';
+--------------------------+-------+
| Variable_name                                      | Value      |
+--------------------------+-------+
| ft_min_word_len                                  | 4                |
| innodb_ft_min_token_size               | 3                |
+--------------------------+-------+
2 rows in set (0.02 sec)
```
fit_min_word_len의 기본값인 4로 지정되어 있는데, 이 경우 4글자 이하의 문자는 무시된다.

### 구분자의 경우
```sql
mysql> select * from INFORMATION_SCHEMA.INNODB_FT_DEFAULT_STOPWORD;
+-------+
| value |
+-------+
| a     |
| about |
| an    |
...
```

## 매치율

매치율이란 풀 텍스트 검색에서 검색어와 검색 대상 텍스트 간의 유사도를 나타내는 지표로, 일반적으로 검색어와 검색 대상 텍스트 간의 일치 정도를 나타내며, 검색 결과의 상대적인 우선순위를 결정하는 데 사용 될 수 있다. 

매치율은 보통 검색어와 검색 대상 텍스트 간의 유사도를 특정 알고리즘을 사용하여 계산하는데, 텍스트 간의 단어 일치 여부, 단어의 중요도 및 가중치, 문맥 및 문장 구조등을 고려하여 매치율을 계산할 수 있다.
- 보통 매치율은 0에서 1사이 값으로 나타내며, 1에 가까울 수록 검색어와 검색 텍스트가 더 유사함을 나타낸다.

검색 결과는 가장 높은 관련성을 가진 결과부터 자동 정렬되는 데, 아래와 같은 조건에 한해 자동 정렬된다.
- ORDER BY 절이 없음
- 검색은 테이블 검색이 아닌 FULLTEXT Index를 사용할까
- 쿼리가 테이블을 조인하는 경우, FULLTEXT Index는 조인에서 가장 왼쪽에 있는 non-constant 테이블이어야 합니다.

```sql
mysql> SELECT match(name) AGAINST('맨투맨') AS score FROM Product LIMIT 0, 10;
+--------------------+
| score              |
+--------------------+
| 0.5844167470932007 |
| 0.5844167470932007 |
|                  0 |
|                  0 |
|                  0 |
| 0.5844167470932007 |
|                  0 |
| 0.5844167470932007 |
|                  0 |
|                  0 |
+--------------------+
10 rows in set (0.00 sec)
```

## 사용

### 검색 최소 글자 수, 토큰 사이즈 변경
